{% extends "base.html" %}

{% block title %}Detalhes do CLP{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/detalhes.css') }}">
{% endblock %}

{% block content %}
<div class="status_clp">
    <span id="statusText" class="{{ 'status_online' if clp.status == 'Online' else 'status_offline' }}">
        Status: {{ clp.status }}
    </span>

    {% if clp.status == "Online" %}
        <button id="btnDisconnect" data-ip="{{ clp.ip }}" class="btn-acao">Desconectar</button>
    {% else %}
      <div class="form-acao">
            <label for="portSelect">Porta:</label>
            <select id="portSelect" class="input-form">
                {% if clp.portas %}
                    {% for porta in clp.portas %}
                        <option value="{{ porta }}">{{ porta }}</option>
                    {% endfor %}
                {% else %}
                    <option value="502">502 (Padrão)</option>
                {% endif %}
            </select>
            <button id="btnConnect" data-ip="{{ clp.ip }}" class="btn-acao">Conectar</button>
        </div>
    {% endif %}
    <div id="mensagemCLP" role="status" style="margin-top:12px;color:var(--accent)"></div>
</div>

<div class="informacao_clp">
    <h2>Informações do CLP</h2>
    <ul>
        <li><strong>Modelo:</strong> {{ clp.get('modelo', 'Desconhecido') }}</li>
        <li><strong>Fabricante:</strong> {{ clp.get('fabricante', 'Desconhecido') }}</li>
        <li><strong>IP:</strong> <span id="clpIp">{{ clp.ip }}</span></li>
        {% if clp.portas %}
            <li><strong>Portas abertas:</strong>
                <span id="listaPortas">
                {% for porta in clp.portas %}
                    <span class="porta_item">{{ porta }}{% if not loop.last %}, {% endif %}</span>
                {% endfor %}
                </span>
            </li>
        {% else %}
            <li><span class="porta_fechada">Não há portas abertas</span></li>
        {% endif %}
        <li><strong>Versão Firmware:</strong> {{ clp.get('firmware', 'N/A') }}</li>
        <li><strong>Última comunicação:</strong> {{ clp.get('data_registro', 'N/A') }}</li>
    </ul>
</div>

<div class="informacao_clp">
    <h2>Leitor de Registrador Modbus</h2>
    <form id="formReadRegister" onsubmit="return false;" class="form-acao">
        <input type="number" id="inputAddress" placeholder="Endereço (ex: 0)" required class="input-form">
        <button id="btnReadRegister" class="btn-acao">Ler Registrador</button>
    </form>
    <div id="readResult" class="resultado-acao" style="margin-top: 10px;"></div>
</div>



<div id="mensagem" role="status" style="margin-top:12px;color:var(--accent)"></div>

<div class="graficos">
    <h2>Métricas do Dispositivo (Exemplo)</h2>
    <div class="linha-graficos">
        <div class="grafico-container">
            <h3>Uso de CPU</h3>
            <canvas id="graficoCpu"></canvas>
        </div>

        <div class="grafico-container">
            <h3>Uso de Memória</h3>
            <canvas id="graficoMemoria"></canvas>
        </div>
    </div>
    <div class="linha-graficos">
        <div class="grafico-container">
            <h3>Tráfego de Rede</h3>
            <canvas id="graficoRede"></canvas>
        </div>

        <div class="grafico-container">
            <h3>Uso de Disco</h3>
            <canvas id="graficoDisco"></canvas>
        </div>
    </div>
</div>

<div class="informacao_clp">
    <h2>Logs de Atividade</h2>
    <div id="logContainer" style="height: 200px; overflow-y: scroll; background-color: rgba(0,0,0,0.2); border-radius: 5px; padding: 10px; font-family: monospace;">
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='scripts/sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='scripts/graficos.js') }}"></script>

<script>
// Função para mostrar mensagens GERAIS (leitura de registrador, etc.)
function showActionMsg(text, timeout=4000) {
    const el = document.getElementById('mensagem');
    if (el) {
        el.textContent = text;
        if (timeout) setTimeout(()=> el.textContent = '', timeout);
    }
}

// Função para mostrar mensagens de CONEXÃO do CLP
function showClpMsg(text, timeout=4000) {
    const el = document.getElementById('mensagemCLP');
    if (el) {
        el.textContent = text;
        if (timeout) setTimeout(()=> el.textContent = '', timeout);
    }
}

async function fetchJson(url, opts) {
    try {
        const resp = await fetch(url, opts);
        if (!resp.ok) {
            return { ok: false, error: `HTTP error! status: ${resp.status}` };
        }
        return await resp.json();
    } catch (err) {
        return { ok: false, error: err.toString() };
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const ip = document.getElementById('clpIp').textContent;
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnReadRegister = document.getElementById('btnReadRegister');
    const logContainer = document.getElementById('logContainer');

    // Botão Conectar usa showClpMsg
    if (btnConnect) {
        btnConnect.addEventListener('click', async () => {
            const selectedPort = document.getElementById('portSelect').value;
            showClpMsg(`Iniciando conexão na porta ${selectedPort}...`);
            
            const res = await fetchJson(`/clp/${ip}/connect`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ port: Number(selectedPort) })
            });

            if (res.ok) {
                showClpMsg(res.message);
                setTimeout(() => atualizarInfo(ip), 3000); 
            } else {
                showClpMsg('Erro: ' + (res.error || 'unknown'));
            }
        });
    }
    
    // Botão Desconectar também usa showClpMsg
    if (btnDisconnect) {
        btnDisconnect.addEventListener('click', async () => {
            showClpMsg('Desconectando...');
            const res = await fetchJson(`/clp/${ip}/disconnect`, { method: 'POST' });
            if (res.ok) {
                showClpMsg('Desconectado');
                window.location.reload();
            } else {
                showClpMsg('Erro: ' + (res.error || 'unknown'));
            }
        });
    }

    // Botão Ler Registrador usa showActionMsg
    if (btnReadRegister) {
        btnReadRegister.addEventListener('click', async () => {
            const address = document.getElementById('inputAddress').value;
            const resultDiv = document.getElementById('readResult');
            if (!address) {
                resultDiv.innerHTML = `<span style="color: red;">Por favor, insira um endereço.</span>`;
                return;
            }
            showActionMsg(`Lendo endereço ${address}...`); // <--- Usa a função de mensagem geral
            const res = await fetchJson(`/clp/${ip}/read_register`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ address: Number(address) })
            });
            if (res.ok) {
                resultDiv.innerHTML = `Endereço <strong>${res.address}</strong> = <strong>${res.value}</strong>`;
                showActionMsg('Leitura concluída com sucesso!');
            } else {
                resultDiv.innerHTML = `<span style="color: red;">Erro: ${res.error}</span>`;
                showActionMsg(`Falha na leitura do endereço ${address}.`);
            }
        });
    }

    // Função para atualizar informações da página
    async function atualizarInfo(ip) {
        const statusAnterior = document.getElementById('statusText').textContent.includes('Online') ? 'Online' : 'Offline';
        const res = await fetchJson(`/clp/${ip}/info`);
        if (!res.ok) return;

        const clp = res.clp;
        const statusEl = document.getElementById('statusText');
        statusEl.textContent = 'Status: ' + clp.status;
        statusEl.className = clp.status === 'Online' ? 'status_online' : 'status_offline';

        if (logContainer && clp.logs) {
            logContainer.innerHTML = '';
            clp.logs.forEach(logLine => {
                const logEntry = document.createElement('div');
                logEntry.textContent = logLine;
                logContainer.appendChild(logEntry);
            });
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        if (clp.status === 'Online' && statusAnterior === 'Offline') {
            window.location.reload();
        }
    }

    // Inicia a atualização periódica
    setInterval(() => atualizarInfo(ip), 5000);
    atualizarInfo(ip);
});
</script>
{% endblock %}