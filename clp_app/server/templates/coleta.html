{% extends "base.html" %}

{% block title %}Coleta de IPS{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/coleta.css') }}">
{% endblock %}

{% block content %}

<div class="container_clps">
    <h1>Coleta de IPS</h1>
    {% if status == "desativado" %}
        <span class="status_offline">Status: Desativado</span>
        <a href="{{ url_for('alterar_coleta_ips') }}" class="teste">Ativar</a>
    {% else %}
        <span class="status_online">Status: Ativado</span>
        <a href="{{ url_for('alterar_coleta_ips') }}" class="teste">Desativar</a>
    {% endif %}
</div>

<div class="container_clps">
    <h2>Histórico</h2>
    <button onclick="limparLogs()">Limpar logs</button>
    <form action="{{ url_for('utils.limpar_coleta_ip') }}" method="POST">
        <button type="submit">Limpar Registros</button>
    </form>
    
    <div id="logs-container" class="logs-container">
        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Nível</th>
                    <th>Mensagem</th>
                </tr>
            </thead>
            <tbody id="log-table-body">
                {% for log in logs %}
                <tr>
                    <td>{{ log.hora }}</td>
                    <td>{{ log.nivel }}</td>
                    <td>{{ log.mensagem }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>
    /**
     * Função para buscar os logs da API e atualizar a tabela.
     */
    async function atualizarLogs() {
        try {
            const response = await fetch('/api/logs/coleta');
            if (!response.ok) {
                console.error('Erro ao buscar logs:', response.statusText);
                return;
            }
            const logs = await response.json();

            const corpoTabela = document.getElementById('log-table-body');
            // Salva a posição da barra de rolagem
            const container = document.getElementById('logs-container');
            const deveRolar = container.scrollTop + container.clientHeight >= container.scrollHeight - 20;

            // Limpa a tabela atual
            corpoTabela.innerHTML = '';

            // Preenche a tabela com os novos logs
            logs.forEach(log => {
                const novaLinha = document.createElement('tr');
                novaLinha.innerHTML = `
                    <td>${log.hora}</td>
                    <td>${log.nivel}</td>
                    <td>${log.mensagem}</td>
                `;
                corpoTabela.appendChild(novaLinha);
            });

            // Se o utilizador estava no final, rola para o novo final
            if (deveRolar) {
                container.scrollTop = container.scrollHeight;
            }

        } catch (error) {
            console.error('Falha na requisição para atualizar logs:', error);
        }
    }

    /**
     * Função para limpar os logs apenas da visualização na tela.
     */
    function limparLogs() {
        const corpoTabela = document.getElementById('log-table-body');
        corpoTabela.innerHTML = ''; 
        console.log("Logs limpos da tela.");
    }

    // Inicia a atualização automática a cada 5 segundos (5000 milissegundos)
    setInterval(atualizarLogs, 2000);

</script>
{% endblock %}